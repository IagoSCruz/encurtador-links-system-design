version: "3.9"

networks:
  encurtador-net:
    driver: bridge

volumes:
  postgres-primary-data:
  postgres-replica1-data:
  postgres-replica2-data:
  postgres-replica3-data:
  redis-data:
  kong-db-data:


services:

  # ===========================================
  # PostgreSQL — Primário (escrita)
  # ===========================================
  postgres-primary:
    image: postgres:16
    container_name: postgres-primary
    restart: unless-stopped
    environment:
      POSTGRES_DB: encurtador
      POSTGRES_USER: encurtador
      POSTGRES_PASSWORD: encurtador123
      POSTGRES_REPLICATION_USER: replicador
      POSTGRES_REPLICATION_PASSWORD: replicador123
    volumes:
      - postgres-primary-data:/var/lib/postgresql/data
      - ./docker/postgres/primary/init.sh:/docker-entrypoint-initdb.d/init.sh
      - ./docker/postgres/postgresql.conf:/etc/postgresql/postgresql.conf
      - ./docker/postgres/pg_hba.conf:/etc/postgresql/pg_hba.conf
    command: postgres -c config_file=/etc/postgresql/postgresql.conf -c hba_file=/etc/postgresql/pg_hba.conf
    ports:
      - "5432:5432"
    networks:
      - encurtador-net
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U encurtador -d encurtador" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # PostgreSQL — Réplica 1 (leitura)
  # ===========================================
  postgres-replica1:
    image: postgres:16
    container_name: postgres-replica1
    restart: unless-stopped
    environment:
      PGUSER: replicador
      PGPASSWORD: replicador123
    volumes:
      - postgres-replica1-data:/var/lib/postgresql/data
      - ./docker/postgres/replica/init-replica.sh:/docker-entrypoint-initdb.d/init-replica.sh
    entrypoint: [ "/bin/bash", "/docker-entrypoint-initdb.d/init-replica.sh" ]
    ports:
      - "5433:5432"
    depends_on:
      postgres-primary:
        condition: service_healthy
    networks:
      - encurtador-net

  # ===========================================
  # PostgreSQL — Réplica 2 (leitura)
  # ===========================================
  postgres-replica2:
    image: postgres:16
    container_name: postgres-replica2
    restart: unless-stopped
    environment:
      PGUSER: replicador
      PGPASSWORD: replicador123
    volumes:
      - postgres-replica2-data:/var/lib/postgresql/data
      - ./docker/postgres/replica/init-replica.sh:/docker-entrypoint-initdb.d/init-replica.sh
    entrypoint: [ "/bin/bash", "/docker-entrypoint-initdb.d/init-replica.sh" ]
    ports:
      - "5434:5432"
    depends_on:
      postgres-primary:
        condition: service_healthy
    networks:
      - encurtador-net

  # ===========================================
  # PostgreSQL — Réplica 3 (leitura)
  # ===========================================
  postgres-replica3:
    image: postgres:16
    container_name: postgres-replica3
    restart: unless-stopped
    environment:
      PGUSER: replicador
      PGPASSWORD: replicador123
    volumes:
      - postgres-replica3-data:/var/lib/postgresql/data
      - ./docker/postgres/replica/init-replica.sh:/docker-entrypoint-initdb.d/init-replica.sh
    entrypoint: [ "/bin/bash", "/docker-entrypoint-initdb.d/init-replica.sh" ]
    ports:
      - "5435:5432"
    depends_on:
      postgres-primary:
        condition: service_healthy
    networks:
      - encurtador-net

  # ===========================================
  # Redis — Cache
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    command: redis-server --requirepass redis123 --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    networks:
      - encurtador-net
    healthcheck:
      test: [ "CMD", "redis-cli", "-a", "redis123", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # Kong — Database (PostgreSQL separado para Kong)
  # ===========================================
  kong-db:
    image: postgres:16
    container_name: kong-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: kong
      POSTGRES_USER: kong
      POSTGRES_PASSWORD: kong123
    volumes:
      - kong-db-data:/var/lib/postgresql/data
    networks:
      - encurtador-net
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U kong -d kong" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # Kong — Migrations (roda uma vez)
  # ===========================================
  kong-migrations:
    image: kong:3.9
    container_name: kong-migrations
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-db
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kong123
      KONG_PG_DATABASE: kong
    command: [ "kong", "migrations", "bootstrap" ]
    depends_on:
      kong-db:
        condition: service_healthy
    networks:
      - encurtador-net
    restart: on-failure

  # ===========================================
  # Kong — API Gateway
  # ===========================================
  kong:
    image: kong:3.9
    container_name: kong
    restart: unless-stopped
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-db
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kong123
      KONG_PG_DATABASE: kong
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
      KONG_PROXY_LISTEN: "0.0.0.0:8000"
    ports:
      - "8000:8000" # Proxy — entrada de requisições
      - "8001:8001" # Admin API — configuração do Kong
    depends_on:
      kong-db:
        condition: service_healthy
      kong-migrations:
        condition: service_completed_successfully
    networks:
      - encurtador-net
    healthcheck:
      test: [ "CMD", "kong", "health" ]
      interval: 15s
      timeout: 10s
      retries: 5
